<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Para ti üíñ</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Dancing+Script:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0b0c1a; --bg2:#171433; --pink:#ff6fae; --lav:#8a80ff; --muted:#cfd0e6; --ok:#28c76f; --danger:#ff6b6b;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;width:100%;overflow:hidden;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial}
  body{
    display:flex;align-items:center;justify-content:center;
    background:
      radial-gradient(60vmax 60vmax at 10% -10%, color-mix(in oklab, var(--lav) 14%, transparent), transparent 70%),
      radial-gradient(50vmax 50vmax at 110% 10%, color-mix(in oklab, var(--pink) 16%, transparent), transparent 70%),
      linear-gradient(120deg, var(--bg1), var(--bg2));
    color:#fff;
  }

  /* Tarjeta del c√≥digo (responsive) */
  .card{
    width:min(92vw,380px);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.12); border-radius:22px; padding:18px;
    box-shadow:0 18px 50px rgba(0,0,0,.45);
  }
  .lock{font-size:clamp(1.8rem,7vw,2.4rem);text-align:center;animation:pulse 1.8s ease-in-out infinite}
  h1{text-align:center;margin:.4rem 0 .2rem;font-size:clamp(1rem,3.6vw,1.1rem)}
  .sub{text-align:center;margin:0 0 .9rem;color:var(--muted);font-size:clamp(.85rem,3.3vw,.95rem)}
  .code-display{
    text-align:center;font-size:clamp(1.2rem,5.4vw,1.4rem);letter-spacing:.28rem;background:#10122a;
    padding:.6rem .9rem;border-radius:12px;margin:0 auto 12px;border:1px solid rgba(255,255,255,.14);width:100%;
    font-variant-numeric:tabular-nums;
  }
  .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:clamp(6px,2.5vw,12px);justify-items:center}
  .key{
    width:clamp(52px,16vw,68px); height:clamp(52px,16vw,68px);
    border-radius:50%; background:linear-gradient(145deg, var(--pink), var(--lav)); border:none;
    font-size:clamp(1rem,4.5vw,1.25rem); color:#16091f; font-weight:700; cursor:pointer; touch-action:manipulation;
    box-shadow:inset -2px -2px 5px rgba(255,255,255,.3), inset 2px 2px 5px rgba(0,0,0,.4), 0 4px 10px rgba(0,0,0,.4);
  }
  .btn-clear{background:linear-gradient(145deg,#ff6b6b,#ff4040);color:#fff}
  .btn-ok{background:linear-gradient(145deg,#28c76f,#1fa85a);color:#fff}
  .feedback{text-align:center;min-height:1.5em;font-size:.95rem;margin-top:.45rem}
  .feedback.error{color:var(--danger)} .feedback.ok{color:var(--ok)}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

  /* Escena fullscreen */
  .fullscreen-scene{
    position:fixed;inset:0;background:#000;overflow:hidden;z-index:999;animation:fadeIn .6s ease both;
    min-height:100vh;
  }
  @supports (height:100svh){ .fullscreen-scene{ min-height:100svh; } }
  @supports (height:100dvh){ .fullscreen-scene{ min-height:100dvh; } }
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  canvas#starfield{position:absolute;inset:0;display:block}
  .horizon{
    position:absolute;left:-10%;right:-10%;bottom:-6%;height:46%;border-radius:50%;
    background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.65) 60%, rgba(0,0,0,.88) 100%);
    filter:blur(1.6px);
  }

  /* Texto fijo */
  .title-wrap{ position:absolute; top:10vh; width:100%; text-align:center; z-index:2; }
  .title-text{
    display:inline-block; font-family:'Dancing Script', cursive; font-size:clamp(1.4rem,5.5vw,2.2rem);
    font-weight:400; font-style:italic; color:white; text-shadow:0 0 8px rgba(0,0,0,.6);
  }

  /* Contenedor del SVG (escena 1) */
  .one-line{
    position:absolute; left:50%;
    bottom: clamp(12px, 8svh, 60px);
    transform:translateX(-50%);
    width: clamp(260px, 68vw, 520px);
    max-width:90vw;
  }
  .one-line svg *{
    fill:none !important; stroke:white !important; stroke-width:3.8 !important; stroke-linecap:round; stroke-linejoin:round; opacity:1;
  }
  .one-line svg circle, .one-line svg ellipse{ display:none !important; }
  .one-line svg path:not(#hugPath){ display:none !important; }
  #hugPath{ stroke-dasharray:1000; stroke-dashoffset:1000; animation:draw 15s ease forwards .5s, glow 3s ease-in-out infinite 15.8s; }
  @keyframes draw{ to{ stroke-dashoffset:0 } }
  @keyframes glow{ 0%,100%{ filter:drop-shadow(0 0 0 rgba(255,255,255,0)) } 50%{ filter:drop-shadow(0 0 6px rgba(255,255,255,.35)) } }

  /* Casillero minimalista */
  .word-check{
    position:fixed;
    bottom: calc(clamp(20px, 10svh, 64px) + var(--safe-bottom));
    left:50%; transform:translateX(-50%);
    display:flex; flex-direction:column; align-items:center; gap:8px;
    padding:10px 14px; color:#fff; background:transparent; border:none; border-radius:16px; z-index:1001;
    animation:pulse-outline 2.5s ease-in-out infinite;
  }
  .word-check::before,.word-check::after{ content:""; position:absolute; inset:0; border:1.5px solid #fff; border-radius:16px; pointer-events:none; }
  .word-check::after{ transform:translate(2px,2px) rotate(.35deg); opacity:.35 }
  .word-check .msg-top{ font-size:clamp(.85rem,3.2vw,.95rem); text-align:center; opacity:.95 }
  .word-check input{
    background:transparent; border:none; border-bottom:1.6px solid #fff; color:#fff;
    padding:6px 4px 4px; min-width:clamp(160px,60vw,320px); text-align:center; outline:none;
    font-size:16px;
  }
  .word-check button{ background:transparent; border:1.6px solid #fff; color:#fff; padding:8px 16px; border-radius:999px; font-weight:700; cursor:pointer; touch-action:manipulation; }
  @keyframes pulse-outline{ 0%,100%{ transform:translateX(-50%) } 50%{ transform:translateX(-50%) } }

  /* Etapa 2 */
  .hidden{ display:none !important; }
  #etapa2{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center; gap:6vmax;
    background:linear-gradient(120deg, var(--bg1), var(--bg2)); color:#fff; z-index:99999;
    overflow:auto;
    padding-top: calc(16px + var(--safe-top));
    padding-right: 6vmin; padding-left: 6vmin;
    padding-bottom: calc(16px + var(--safe-bottom));
    min-height:100vh;
  }
  @supports (height:100svh){ #etapa2{ min-height:100svh; } }
  @supports (height:100dvh){ #etapa2{ min-height:100dvh; } }

  .et2-texto{ max-width:740px; line-height:1.6 }
  .et2-titulo{ font-family:"Dancing Script", cursive; font-size:clamp(32px,6vw,64px); margin-bottom:10px }
  .et2-historia{ color:var(--muted); font-size:clamp(14px,3.5vw,18px); margin-bottom:18px }

  .cielo{
    width: clamp(260px, 80vw, 420px); aspect-ratio:1/1.2;
    position:relative; border-radius:28px; padding:clamp(12px,3.5vw,18px);
    overflow:hidden; background:transparent; border:1px dashed rgba(255,255,255,.25);
  }
  .moon-mount svg{ width:100%; height:100% }
  .moon-mount svg *{ fill:none !important; stroke:#fff !important; stroke-linecap:round; stroke-linejoin:round; }
  .moon-mount svg .mono-line{ stroke-width:7; }

  /* ‚ÄúTe amo mucho‚Äù animaci√≥n base */
  .teamo{ width: clamp(280px, 92vw, 820px); height:auto }
  .teamo text{
    font-family:'Dancing Script', cursive;
    font-size:clamp(68px, 20vw, 160px);
    fill:none; stroke:#fff; stroke-width:2.2; stroke-dasharray:1800; stroke-dashoffset:1800;
    animation: drawText 4s ease forwards .2s, glow 3s ease-in-out infinite 4.6s;
  }
  @keyframes drawText{ to{ stroke-dashoffset:0 } }
  @keyframes glow{ 0%,100%{ filter:drop-shadow(0 0 0 rgba(255,255,255,0)) } 50%{ filter:drop-shadow(0 0 6px rgba(255,255,255,.35)) } }

  @media (max-width: 720px){
    #etapa2{ flex-direction:column; align-items:center; justify-content:flex-start; gap:20px; }
    .et2-texto{ max-width:92vw; }
    .cielo{ width:88vw; border-radius:20px; }
  }
  @media (max-height: 640px){
    .title-text{ font-size: clamp(1.1rem, 5vw, 1.6rem); }
    .one-line{ width: clamp(220px, 60vw, 420px); bottom: max(8px, calc(6svh + var(--safe-bottom))); }
    .key{ width: clamp(48px,14vw,62px); height: clamp(48px,14vw,62px); }
  }

  .title-wrap{ top: max(8svh, calc(var(--safe-top) + 12px)); }
  .one-line{ bottom: max(12px, calc(8svh + var(--safe-bottom))); }
</style>
</head>
<body>
  <!-- Tarjeta -->
  <section class="card" id="card">
    <div class="lock">üîí</div>
    <h1>Introduce el c√≥digo secreto</h1>
    <p class="sub">Pista: una fecha muy importante üíï</p>
    <div id="codeDisplay" class="code-display">¬∑¬∑¬∑¬∑¬∑¬∑</div>
    <div class="keypad" id="keypad">
      <button class="key">1</button><button class="key">2</button><button class="key">3</button>
      <button class="key">4</button><button class="key">5</button><button class="key">6</button>
      <button class="key">7</button><button class="key">8</button><button class="key">9</button>
      <button class="key btn-clear" aria-label="Borrar">‚å´</button><button class="key">0</button><button class="key btn-ok" aria-label="Aceptar">‚úî</button>
    </div>
    <div id="feedback" class="feedback"></div>
  </section>

<script>
const SECRET_CODE="051224";
let enteredCode="";
const card=document.getElementById("card");
const codeDisplay=document.getElementById("codeDisplay");
const feedback=document.getElementById("feedback");
const keypad=document.getElementById("keypad");

keypad.addEventListener("click",e=>{
  const btn=e.target.closest(".key"); if(!btn) return;
  const val=btn.textContent.trim();
  if(val==="‚å´"){ enteredCode=enteredCode.slice(0,-1); updateDisplay(); return; }
  if(val==="‚úî"){ checkCode(); return; }
  if(enteredCode.length<SECRET_CODE.length && /^\d$/.test(val)){ enteredCode+=val; updateDisplay(); }
});
function updateDisplay(){
  const p="¬∑¬∑¬∑¬∑¬∑¬∑"; codeDisplay.textContent=(enteredCode+p).slice(0,SECRET_CODE.length);
}
function checkCode(){
  if(enteredCode===SECRET_CODE){
    feedback.textContent="¬°Correcto!"; feedback.className="feedback ok";
    card.remove(); showFullscreenScene();
  }else{
    feedback.textContent="C√≥digo incorrecto"; feedback.className="feedback error";
    enteredCode=""; updateDisplay();
  }
}
updateDisplay();

function showFullscreenScene(){
  const scene=document.createElement('div');
  scene.className='fullscreen-scene';
  scene.innerHTML=`
    <canvas id="starfield"></canvas>
    <div class="horizon"></div>
    <div class="title-wrap">
      <span class="title-text">¬øTe acuerdas de este momento?</span>
    </div>
    <div id="svgMount" class="one-line" aria-label="Silueta l√≠nea continua"></div>
  `;
  document.body.appendChild(scene);

  loadExternalSVG('svg/silueta-2.svg');
  initStars();
}

function loadExternalSVG(url){
  const mount = document.getElementById('svgMount');
  fetch(encodeURI(url), { cache: 'no-store' })
    .then(r => {
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.text();
    })
    .then(txt => {
      mount.innerHTML = txt; 
      const svg = mount.querySelector('svg');
      if(!svg) return;
      svg.classList.add('one-line');
      svg.setAttribute('preserveAspectRatio','xMidYMax meet');
      if(!svg.getAttribute('viewBox')) svg.setAttribute('viewBox','0 0 1200 900');
      const p = svg.querySelector('#hugPath') || svg.querySelector('path');
      if(p){
        p.id = 'hugPath';
        if(!p.getAttribute('pathLength')) p.setAttribute('pathLength','1000');
      }
    })
    .catch(err => {
      console.error('Error cargando SVG:', err);
      mount.innerHTML = `<div style="text-align:center;color:#ff8080">No se pudo cargar el SVG üò¢</div>`;
    });
}

function initStars(){
  const canvas=document.getElementById('starfield'); const ctx=canvas.getContext('2d');
  function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
  resize(); addEventListener('resize', resize);
  const STAR_COUNT=Math.floor((innerWidth*innerHeight)/6000);
  const stars=Array.from({length:STAR_COUNT},()=>({
    x:Math.random()*canvas.width, y:Math.random()*canvas.height,
    r:Math.random()*0.9+0.2, baseAlpha:Math.random()*0.6+0.2,
    speed:Math.random()*0.4+0.1, phase:Math.random()*Math.PI*2,
    drift:(Math.random()*0.06)*(Math.random()<0.5?-1:1)
  }));
  let last=0;
  function draw(t){
    if(t-last<1000/60){ requestAnimationFrame(draw); return; }
    last=t; ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const s of stars){
      s.y+=s.drift; if(s.y<0)s.y=canvas.height; if(s.y>canvas.height)s.y=0;
      const a=s.baseAlpha+0.22*Math.sin(t/1000*s.speed+s.phase);
      ctx.globalAlpha=Math.max(0,Math.min(1,a));
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();
    }
    ctx.globalAlpha=1; requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
}
</script>

<!-- ========== AGREGADOS: casillero + ETAPA 2 (carga monito_luna.svg) ========== -->
<script>
  (function(){
    function addWordBox(){
      const mount = document.getElementById('svgMount');
      if(!mount) return;
      if(document.querySelector('.word-check')) return;

      const box = document.createElement('form');
      box.className = 'word-check';
      box.setAttribute('autocomplete','off');
      box.innerHTML = `
        <div class="msg-top">Ingresa una palabra que te recuerde a ese momento</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <label style="display:none">Palabra</label>
          <input id="wordInput" type="text" placeholder="escribe aqu√≠" inputmode="text" autocomplete="off">
          <button id="checkWord" type="button">‚úî</button>
        </div>
      `;
      mount.insertAdjacentElement('afterend', box);
    }

    function loadSVGInto(url, mountId, opts = {}) {
      const mount = document.getElementById(mountId);
      if (!mount) return;
      fetch(encodeURI(url), { cache: 'no-store' })
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); })
        .then(txt => {
          mount.innerHTML = txt;
          mergeMonkeyPaths(mountId);
          centerMonkey(mountId, opts.offsetX || 0, opts.offsetY || 0);
        })
        .catch(err => {
          console.error('Error cargando', url, err);
          mount.innerHTML = `<div style="text-align:center;color:#ff8080">No se pudo cargar monito_luna.svg üò¢</div>`;
        });
    }

    function findMonkeyNode(svg){
      let monito = svg.querySelector('#monito, #mono, #monkey, g[id*="mono"], g[id*="monk"]');
      if(!monito){
        const groups = Array.from(svg.querySelectorAll('g'));
        if(groups.length){
          let best=null, score=-Infinity;
          for(const g of groups){
            try{
              const b=g.getBBox();
              const s=(b.y+b.height/2) + (b.width*b.height)*0.0001;
              if(s>score){ score=s; best=g; }
            }catch{}
          }
          monito = best;
        }
      }
      return monito;
    }

    function mergeMonkeyPaths(mountId){
      const svg = document.querySelector(`#${mountId} svg`);
      if(!svg) return;
      const monito = findMonkeyNode(svg);
      if(!monito) return;

      const pieces = monito.querySelectorAll('path, polyline, line, polygon');
      if(!pieces.length) return;

      const segs=[];
      pieces.forEach(el=>{
        let d='';
        if(el.tagName==='path'){
          d = el.getAttribute('d') || '';
        }else if(el.tagName==='polyline' || el.tagName==='polygon'){
          const raw = (el.getAttribute('points')||'').trim().split(/[\s,]+/).map(Number);
          if(raw.length>=4){
            d = `M ${raw[0]} ${raw[1]}`;
            for(let i=2;i<raw.length;i+=2){ d += ` L ${raw[i]} ${raw[i+1]}`; }
            if(el.tagName==='polygon') d += ' Z';
          }
        }else if(el.tagName==='line'){
          const x1=el.getAttribute('x1')||0, y1=el.getAttribute('y1')||0, x2=el.getAttribute('x2')||0, y2=el.getAttribute('y2')||0;
          d = `M ${x1} ${y1} L ${x2} ${y2}`;
        }
        if(d) segs.push(d);
      });
      if(!segs.length) return;

      const merged = document.createElementNS('http://www.w3.org/2000/svg','path');
      merged.setAttribute('d', segs.join(' '));
      merged.setAttribute('class','mono-line');
      merged.setAttribute('fill','none');

      pieces.forEach(el=>el.remove());
      monito.appendChild(merged);
    }

    function centerMonkey(mountId, offsetX = 0, offsetY = 0) {
      const svg = document.querySelector(`#${mountId} svg`);
      if (!svg) return;

      const vb = svg.viewBox && svg.viewBox.baseVal
        ? svg.viewBox.baseVal
        : { x: 0, y: 0, width: svg.getBBox().width, height: svg.getBBox().height };

      const monito = findMonkeyNode(svg);
      if(!monito) return;

      const bb = monito.getBBox();
      const cx = vb.x + vb.width/2;
      const cy = vb.y + vb.height/2;
      const tx = cx - (bb.x + bb.width/2) + offsetX;
      const ty = cy - (bb.y + bb.height/2) + offsetY;

      const prev = monito.getAttribute('transform') || '';
      monito.setAttribute('transform', `${prev} translate(${tx},${ty})`);
    }

    function ensureEtapa2(){
      if(document.getElementById('etapa2')) return;
      const et = document.createElement('section');
      et.id = 'etapa2';
      et.className = 'hidden';
      et.setAttribute('aria-hidden','true');
      et.innerHTML = `
        <div class="et2-texto">
          <h2 class="et2-titulo">Si, es nuestra primera amanecida.</h2>
          <p class="et2-historia">
            Ten√≠amos poquito tiempo de conocernos, y creo que en esa amanecida aprendimos mucho de nosotras.
            Fue un momento super bonito, solo nosotras en la oscuridad, en locales de comida r√°pida,
            bajo la noche (sin estrellas), pero queri√©ndonos y afianzando nuestra confianza cada d√≠a mas.
            Este recuerdo es uno de mis favoritos. Espero que alg√∫n d√≠a, sigamos teniendo m√°s an√©cdotas como estas.
            Viviendo nuestra vida, creando m√°s momentos, pero juntas. Te amo mucho.
          </p>
          <svg class="teamo" viewBox="0 0 1000 220" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Te amo mucho dibujado">
            <text x="50%" y="60%" text-anchor="middle">Te amo mucho</text>
          </svg>
        </div>
        <aside class="cielo" aria-label="Monito y luna">
          <div id="moonMount" class="moon-mount"></div>
        </aside>
      `;
      document.body.appendChild(et);
    }

    const norm = s => (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();

    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id === 'checkWord'){
        const input = document.getElementById('wordInput');
        if(!input) return;
        const ok = norm(input.value) === norm('amanecida');
        if(ok){
          const scene = document.querySelector('.fullscreen-scene');
          if(scene) scene.style.display = 'none';
          ensureEtapa2();
          loadSVGInto('svg/monito_luna.svg', 'moonMount', { offsetX: 0, offsetY: 90 });
          const et2 = document.getElementById('etapa2');
          et2.classList.remove('hidden');
          et2.setAttribute('aria-hidden','false');
          window.scrollTo({top:0, behavior:'smooth'});
        }else{
          input.style.borderBottomColor = '#ff6b6b';
          setTimeout(()=>{ input.style.borderBottomColor = '#fff'; }, 450);
        }
      }
    });

    const obs = new MutationObserver(()=>{
      const mount = document.getElementById('svgMount');
      if(mount){
        addWordBox();
        obs.disconnect();
      }
    });
    obs.observe(document.body,{childList:true,subtree:true});
  })();
</script>

<!-- ======== FIX EXTRA ANDROID: altura visible real con --vh ======== -->
<style>
  :root{ --vh: 1vh; }
  .fullscreen-scene{ min-height: calc(var(--vh, 1vh) * 100) !important; }
  #etapa2{
    min-height: calc(var(--vh, 1vh) * 100) !important;
    overflow: auto;
    padding-top: calc(16px + env(safe-area-inset-top, 0px));
    padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
  }
  .title-wrap{ top: max(8svh, calc(env(safe-area-inset-top,0px) + 12px)); }
  .one-line{ bottom: max(12px, calc(8svh + env(safe-area-inset-bottom,0px))); }
  .word-check{
    position: fixed;
    bottom: calc(clamp(20px, 10svh, 64px) + env(safe-area-inset-bottom,0px));
    left: 50%; transform: translateX(-50%);
    z-index: 1001;
  }
</style>
<script>
  (function(){
    const setVh = () => {
      const h = (window.visualViewport ? window.visualViewport.height : window.innerHeight) * 0.01;
      document.documentElement.style.setProperty('--vh', `${h}px`);
    };
    setVh();
    window.addEventListener('resize', setVh, {passive:true});
    window.addEventListener('orientationchange', setVh, {passive:true});
    if (window.visualViewport){
      window.visualViewport.addEventListener('resize', setVh, {passive:true});
      window.visualViewport.addEventListener('scroll', setVh, {passive:true});
    }
  })();
</script>

<!-- ========== OVERRIDES PEDIDOS: silueta m√°s arriba + ‚ÄúTe amo mucho‚Äù m√°s grande ========== -->
<style>
  /* Sube la silueta del primer SVG */
  .one-line{
    bottom: max(24px, calc(18svh + env(safe-area-inset-bottom, 0px))) !important;
  }
  @media (min-width: 900px){
    .one-line{
      bottom: max(32px, calc(14svh + env(safe-area-inset-bottom, 0px))) !important;
    }
  }
  /* ‚ÄúTe amo mucho‚Äù M√ÅS GRANDE */
  #etapa2 .teamo{ width: clamp(360px, 98vw, 1200px) !important; }
  #etapa2 .teamo text{
    font-size: clamp(68px, 15vw, 160px) !important;
    stroke-width: 2.8 !important;
  }
</style>
</body>
</html>
